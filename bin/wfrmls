#!/usr/bin/env ruby

CONFIG_FILE_NAME = File.expand_path('~/wfrmls_config.yml')

require 'watir'
require 'watir/ie'
require 'wfrmls/ie'
require 'wfrmls/cli/options'

options = Wfrmls::CLI::Options.parse! ARGV

config = nil
begin
  config = YAML::load_file(CONFIG_FILE_NAME)
rescue => e
  # TODO initialize password
  #File.open(CONFIG_FILE_NAME, 'w') do |item|
  #end
end

ie = Watir::Browser.new

auth = config ?
  Wfrmls::AutomaticAuthenticator.new(ie, config['username'], config['password']) :
  Wfrmls::ManualAuthenticator.new(ie)

Watir::Browser.default = 'ie'

mls = Wfrmls::IE.new(ie, auth)

if options.address.empty?
  begin
    mls.lookup_address(nil)
  rescue
    exit
  end
end

addr = StreetAddress::US.parse(options.address)
if addr.nil?
  addr = StreetAddress::US.parse(options.address+', UT')
end

puts addr

if options.opposition?
  mls.lookup_opposition(addr)
else
  details = mls.collect_property_details(addr)
  puts details.to_yaml
  if options.comp?
    mls.comp(addr, details)
  else
    mls.lookup_address(addr)
  end
end
